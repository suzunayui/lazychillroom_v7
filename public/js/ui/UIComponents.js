// UIÈÉ®ÂìÅÈñ¢ÈÄ£„ÅÆ„ÇØ„É©„Çπ
class UIComponents {
    // „ÉÅ„É£„ÉÉ„Éà„Ç≥„É≥„ÉÜ„Éä„ÅÆHTML„ÇíÁîüÊàê
    static createChatContainer(currentUser) {
        return `
            <div class="chat-container">
                <!-- Â∑¶„Çµ„Ç§„Éâ„Éê„ÉºÔºà„Çµ„Éº„Éê„ÉºÈÅ∏Êäû„Å®DMÔºâ -->
                <div class="left-sidebar">
                    <!-- „ÉÄ„Ç§„É¨„ÇØ„Éà„É°„ÉÉ„Çª„Éº„Ç∏„Éú„Çø„É≥ -->
                    <div class="dm-button-section">
                        <div class="dm-button" id="dmButton">
                            <div class="dm-button-icon">@</div>
                        </div>
                    </div>

                    <!-- Âå∫Âàá„ÇäÁ∑ö -->
                    <div class="separator"></div>

                    <!-- „Çµ„Éº„Éê„ÉºÈÅ∏Êäû„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="servers-section">
                        <div class="servers-list" id="serversList">
                            <!-- „Çµ„Éº„Éê„Éº„É™„Çπ„Éà„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>

                <!-- „É°„Ç§„É≥„Çµ„Ç§„Éâ„Éê„Éº -->
                <div class="sidebar">
                    <div class="server-info">
                        <div class="user-info">
                            <div class="user-avatar">
                                ${currentUser.avatar_url ? 
                                    `<img src="${currentUser.avatar_url}" alt="„Ç¢„Éê„Çø„Éº" class="user-avatar-img">` : 
                                    `<span>${(currentUser.nickname || currentUser.username).charAt(0).toUpperCase()}</span>`
                                }
                            </div>
                            <div class="user-details">
                                <div class="username clickable-username" id="usernameBtn" title="„Éû„Ç§„Çµ„Éº„Éê„Éº„ÇíÈñã„Åè">${currentUser.nickname || currentUser.username}</div>
                                <div class="user-status">„Ç™„É≥„É©„Ç§„É≥</div>
                                <button class="my-server-btn" id="myServerBtn" title="„Éû„Ç§„Çµ„Éº„Éê„Éº">üè† „Éû„Ç§„Çµ„Éº„Éê„Éº</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- „ÉÜ„Ç≠„Çπ„Éà„ÉÅ„É£„É≥„Éç„É´„Çª„ÇØ„Ç∑„Éß„É≥ -->
                    <div class="channels-section" id="channelsSection">
                        <div class="section-header">
                            <span id="sectionTitle">„ÉÜ„Ç≠„Çπ„Éà„ÉÅ„É£„É≥„Éç„É´</span>
                            <button class="add-channel-btn" id="addChannelBtn" title="„ÉÅ„É£„É≥„Éç„É´„ÇíËøΩÂä†">+</button>
                        </div>
                        <div class="channels-list" id="channelsList">
                            <!-- „ÉÅ„É£„É≥„Éç„É´„É™„Çπ„Éà„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                        </div>
                    </div>

                    <div class="user-controls">
                        <button class="control-button" id="logoutBtn">
                            <span>„É≠„Ç∞„Ç¢„Ç¶„Éà</span>
                        </button>
                    </div>
                </div>

                <!-- „É°„Ç§„É≥„ÉÅ„É£„ÉÉ„Éà„Ç®„É™„Ç¢ -->
                <div class="main-content">
                    <div class="chat-header">
                        <button class="mobile-menu-toggle" id="mobileMenuToggle">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"/>
                            </svg>
                        </button>
                        <div class="channel-info">
                            <span class="channel-hash" id="channelHash">#</span>
                            <span class="channel-name" id="currentChannelName">„ÉÅ„É£„É≥„Éç„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span>
                            <span class="channel-topic" id="channelTopic">...</span>
                        </div>
                        <button class="mobile-members-toggle" id="mobileMembersToggle">
                            <svg width="24" height="24" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M16,4C18.11,4 20,5.89 20,8C20,10.11 18.11,12 16,12C13.89,12 12,10.11 12,8C12,5.89 13.89,4 16,4M16,14C20.42,14 24,15.79 24,18V20H8V18C8,15.79 11.58,14 16,14M6,6H10V8H6V6M6,10H10V12H6V10M6,14H10V16H6V14Z"/>
                            </svg>
                        </button>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="welcome-message">
                            <h3>LazyChillRoom„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅüéâ</h3>
                            <p>„Çµ„Éº„Éê„Éº„Åæ„Åü„ÅØDM„ÇíÈÅ∏Êäû„Åó„Å¶„ÉÅ„É£„ÉÉ„Éà„ÇíÈñãÂßã„Åó„Åæ„Åó„Çá„ÅÜ„ÄÇ</p>
                        </div>
                    </div>
                    
                    <!-- „Çø„Ç§„Éî„É≥„Ç∞„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
                    <div id="typing-indicator" class="typing-indicator" style="display: none;"></div>

                    <!-- Ëøî‰ø°„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº -->
                    <div class="reply-indicator" style="display: none;"></div>

                    <div class="chat-input-container">
                        <form class="chat-input-form" id="chatForm">
                            <div class="chat-input-wrapper">
                                <button type="button" class="file-upload-button" id="fileUploadBtn" title="„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ">
                                    <svg width="20" height="20" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                    </svg>
                                </button>
                                <input 
                                    type="file" 
                                    id="fileInput" 
                                    style="display: none;"
                                    accept="image/*,.pdf,.doc,.docx,.txt"
                                    multiple
                                >
                                <input 
                                    type="text" 
                                    class="chat-input" 
                                    id="messageInput"
                                    placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                                    autocomplete="off"
                                >
                                <button type="submit" class="send-button">
                                    <svg width="24" height="24" viewBox="0 0 24 24">
                                        <path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                                    </svg>
                                </button>
                            </div>
                        </form>
                        <div class="file-preview-container" id="filePreviewContainer" style="display: none;">
                            <div class="file-preview-header">
                                <span>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∫àÂÆö„ÅÆ„Éï„Ç°„Ç§„É´:</span>
                                <button type="button" class="clear-files-btn" id="clearFilesBtn">√ó</button>
                            </div>
                            <div class="file-preview-list" id="filePreviewList"></div>
                        </div>
                        <div class="drag-drop-overlay" id="dragDropOverlay">
                            <div class="drag-drop-content">
                                <svg width="48" height="48" viewBox="0 0 24 24">
                                    <path fill="currentColor" d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                                <h3>„Éï„Ç°„Ç§„É´„Çí„Éâ„É≠„ÉÉ„Éó„Åó„Å¶„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</h3>
                                <p>ÁîªÂÉè„ÄÅPDF„ÄÅ„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´„Å™„Å©</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- „É°„É≥„Éê„Éº„É™„Çπ„ÉàÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ -->
                <div class="members-sidebar" id="membersSidebar">
                    <div class="members-header">
                        <span id="membersCount">„É°„É≥„Éê„Éº - 4</span>
                        <button class="close-members-btn" id="closeMembersBtn" title="„É°„É≥„Éê„Éº„É™„Çπ„Éà„ÇíÈñâ„Åò„Çã" style="display: none;">√ó</button>
                    </div>
                    <div class="members-list">
                        <!-- „Ç™„É≥„É©„Ç§„É≥„É°„É≥„Éê„Éº -->
                        <div class="members-section">
                            <div class="members-section-header">
                                <span class="section-title" id="onlineMembersTitle">„Ç™„É≥„É©„Ç§„É≥ - 0</span>
                            </div>
                            <div class="members-group" id="onlineMembers">
                                <!-- „Çµ„Éº„Éê„ÉºÈÅ∏ÊäûÊôÇ„Å´„Ç™„É≥„É©„Ç§„É≥„É°„É≥„Éê„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô -->
                            </div>
                        </div>

                        <!-- „Ç™„Éï„É©„Ç§„É≥„É°„É≥„Éê„Éº -->
                        <div class="members-section">
                            <div class="members-section-header">
                                <span class="section-title" id="offlineMembersTitle">„Ç™„Éï„É©„Ç§„É≥ - 0</span>
                            </div>
                            <div class="members-group" id="offlineMembers">
                                <!-- „Çµ„Éº„Éê„ÉºÈÅ∏ÊäûÊôÇ„Å´„Ç™„Éï„É©„Ç§„É≥„É°„É≥„Éê„Éº„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ‰∏ÄÊôÇÁöÑ„Å™„É°„ÉÉ„Çª„Éº„Ç∏Ë¶ÅÁ¥†„Çí‰ΩúÊàê
    static createTemporaryMessage(currentUser, content) {
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.innerHTML = `
            <div class="message-avatar">
                <span>${(currentUser.nickname || currentUser.username).charAt(0).toUpperCase()}</span>
            </div>
            <div class="message-content">
                <div class="message-header">
                    <span class="message-author">${currentUser.nickname || currentUser.username}</span>
                    <span class="message-timestamp">${TimeUtils.getCurrentJSTTime()}</span>
                </div>
                <div class="message-text">${content}</div>
            </div>
        `;
        return messageElement;
    }

    // „Çµ„Éº„Éê„Éº„É™„Çπ„Éà„ÅÆHTML„ÇíÁîüÊàê
    static createServerListHTML(guilds) {
        console.log('UIComponents: „Çµ„Éº„Éê„Éº„É™„Çπ„ÉàHTMLÁîüÊàê‰∏≠...', guilds);
        let html = '';
        
        guilds.forEach(guild => {
            const serverName = guild.name || `„Çµ„Éº„Éê„Éº${guild.id}`;
            
            // „Ç¢„Ç§„Ç≥„É≥„Åæ„Åü„ÅØ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊ±∫ÂÆö
            let iconContent;
            if (guild.icon_url) {
                // Áõ∏ÂØæ„Éë„Çπ„Åß„Ç¢„ÇØ„Çª„Çπ„Åß„Åç„Çã„Çà„ÅÜ„Å´„Éë„Çπ„ÇíË™øÊï¥
                let iconPath = guild.icon_url;
                if (iconPath.startsWith('/')) {
                    iconPath = iconPath.substring(1); // ÂÖàÈ†≠„ÅÆ/„ÇíÂâäÈô§
                }
                const fallbackText = guild.name ? guild.name.substring(0, 2).toUpperCase() : 'S';
                iconContent = `<img src="${iconPath}" alt="${serverName}" class="server-icon-img" data-fallback="${fallbackText}" data-guild-id="${guild.id}">`;
                console.log(`UIComponents: „Çµ„Éº„Éê„ÉºËøΩÂä† - ID: ${guild.id}, ÂêçÂâç: ${serverName}, „Ç¢„Ç§„Ç≥„É≥ÁîªÂÉè: ${iconPath}`);
            } else {
                const iconText = guild.name ? guild.name.substring(0, 2).toUpperCase() : 'S';
                iconContent = iconText;
                console.log(`UIComponents: „Çµ„Éº„Éê„ÉºËøΩÂä† - ID: ${guild.id}, ÂêçÂâç: ${serverName}, „Ç¢„Ç§„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà: ${iconText}`);
            }
            
            html += `
                <div class="server-item" data-server="${guild.id}" title="${serverName}">
                    <div class="server-icon">${iconContent}</div>
                </div>
            `;
        });
        
        // „Çµ„Éº„Éê„ÉºËøΩÂä†„Éú„Çø„É≥
        html += `
            <div class="server-item add-server" id="addServerBtn" title="„Çµ„Éº„Éê„Éº„ÇíËøΩÂä†">
                <div class="server-icon plus">+</div>
            </div>
        `;
        
        console.log('UIComponents: ÁîüÊàê„Åï„Çå„ÅüHTML:', html);
        
        // HTML„ÇíË®≠ÂÆöÂæå„ÄÅÁîªÂÉè„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíË®≠ÂÆö
        setTimeout(() => {
            UIComponents.setupImageErrorHandling();
        }, 100);
        
        return html;
    }
    
    // ÁîªÂÉè„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíË®≠ÂÆö
    static setupImageErrorHandling() {
        const images = document.querySelectorAll('.server-icon-img');
        images.forEach(img => {
            img.onerror = function() {
                const fallback = this.getAttribute('data-fallback') || 'S';
                const guildId = this.getAttribute('data-guild-id');
                console.log(`ÁîªÂÉèË™≠„ÅøËæº„ÅøÂ§±Êïó (Guild ID: ${guildId}):`, this.src, '„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ:', fallback);
                this.style.display = 'none';
                this.parentNode.innerHTML = fallback;
            };
        });
    }
    
    // „Éá„Éê„ÉÉ„Ç∞Áî®: „Çµ„Éº„Éê„Éº„Ç¢„Ç§„Ç≥„É≥„ÅÆÁä∂Ê≥Å„ÇíÁ¢∫Ë™ç
    static debugServerIcons() {
        const serverItems = document.querySelectorAll('.server-item:not(.add-server)');
        console.log('=== „Çµ„Éº„Éê„Éº„Ç¢„Ç§„Ç≥„É≥„Éá„Éê„ÉÉ„Ç∞ ===');
        console.log(`„Çµ„Éº„Éê„ÉºÊï∞: ${serverItems.length}`);
        
        serverItems.forEach((item, index) => {
            const serverId = item.dataset.server;
            const icon = item.querySelector('.server-icon');
            const img = icon ? icon.querySelector('.server-icon-img') : null;
            
            console.log(`\n„Çµ„Éº„Éê„Éº ${index + 1}:`);
            console.log(`  ID: ${serverId}`);
            console.log(`  „Çø„Ç§„Éà„É´: ${item.title}`);
            console.log(`  „Ç¢„Ç§„Ç≥„É≥HTML: ${icon ? icon.innerHTML : '„Å™„Åó'}`);
            
            if (img) {
                console.log(`  ÁîªÂÉè„ÇΩ„Éº„Çπ: ${img.src}`);
                console.log(`  ÁîªÂÉèÁä∂ÊÖã: ${img.complete ? 'Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü' : 'Ë™≠„ÅøËæº„Åø‰∏≠'}`);
                console.log(`  ÁîªÂÉèË°®Á§∫: ${img.style.display === 'none' ? 'ÈùûË°®Á§∫' : 'Ë°®Á§∫'}`);
                console.log(`  „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: ${img.getAttribute('data-fallback')}`);
            } else {
                console.log(`  „ÉÜ„Ç≠„Çπ„Éà„Ç¢„Ç§„Ç≥„É≥: ${icon ? icon.textContent : '„Å™„Åó'}`);
            }
        });
        
        return { serverCount: serverItems.length, items: serverItems };
    }

    // „ÉÅ„É£„É≥„Éç„É´„É™„Çπ„Éà„ÅÆHTML„ÇíÁîüÊàê
    static createChannelListHTML(channels) {
        let html = '';
        
        channels.forEach(channel => {
            if (channel.type === 'text' || channel.type === 'settings') {
                if (channel.name === 'Ë®≠ÂÆö' || channel.type === 'settings') {
                    html += `
                        <div class="channel-item uploader-channel" data-channel="${channel.id}">
                            <span class="channel-icon">‚öôÔ∏è</span>
                            <span class="channel-name">${channel.name}</span>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="channel-item" data-channel="${channel.id}">
                            <span class="channel-hash">#</span>
                            <span class="channel-name">${channel.name}</span>
                        </div>
                    `;
                }
            } else if (channel.type === 'uploader_public') {
                html += `
                    <div class="channel-item uploader-channel" data-channel="${channel.id}">
                        <span class="channel-icon">üåê</span>
                        <span class="channel-name">${channel.name}</span>
                    </div>
                `;
            } else if (channel.type === 'uploader_private') {
                html += `
                    <div class="channel-item uploader-channel" data-channel="${channel.id}">
                        <span class="channel-icon">üîí</span>
                        <span class="channel-name">${channel.name}</span>
                    </div>
                `;
            }
        });
        
        return html;
    }

    // DM„É¶„Éº„Ç∂„Éº„É™„Çπ„Éà„ÅÆHTML„ÇíÁîüÊàê
    static createDMUserListHTML(dmChannels) {
        let html = '';
        dmChannels.forEach(dm => {
            const participant = dm.participants[0]; // ÊúÄÂàù„ÅÆÂèÇÂä†ËÄÖÔºàËá™ÂàÜ‰ª•Â§ñÔºâ
            if (participant) {
                html += `
                    <div class="dm-user-item" data-dm="${dm.id}">
                        <div class="dm-avatar">${(participant.nickname || participant.username).charAt(0).toUpperCase()}</div>
                        <span class="dm-name">${participant.nickname || participant.username}</span>
                        <div class="dm-status online"></div>
                    </div>
                `;
            }
        });
        
        // „Éï„É¨„É≥„ÉâËøΩÂä†„Éú„Çø„É≥
        html += `
            <div class="dm-user-item add-friend" id="addFriendBtn">
                <div class="dm-avatar plus">+</div>
                <span class="dm-name">„Éï„É¨„É≥„Éâ„ÇíËøΩÂä†</span>
            </div>
        `;
        
        return html;
    }

    // „É°„É≥„Éê„Éº„É™„Çπ„Éà„ÅÆHTML„ÇíÁîüÊàê
    static createMemberListHTML(members, type) {
        return members.map(member => {
            // „Éá„Éê„ÉÉ„Ç∞Âá∫Âäõ
            console.log('üîç Member data:', member);
            console.log('üîç Member id:', member.id);
            console.log('üîç Member user_id:', member.user_id);
            console.log('üîç Member avatar_url:', member.avatar_url);
            
            // ÁèæÂú®„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Çã„É¶„Éº„Ç∂„Éº„ÅÆÊÉÖÂ†±„ÇíÂèñÂæó
            const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
            console.log('üîç Current user:', currentUser);
            
            // user_id„Éï„Ç£„Éº„É´„Éâ„ÇíÊ≠£„Åó„ÅèÂèñÂæóÔºàAPI„Åã„Çâ„ÅØid„Å®„Åó„Å¶Ëøî„Åï„Çå„ÇãÔºâ
            const memberId = member.user_id || member.id;
            
            // „Ç¢„Éê„Çø„ÉºË°®Á§∫„ÅÆÊ±∫ÂÆö
            let avatarContent;
            if (currentUser && currentUser.id && memberId == currentUser.id && currentUser.avatar_url) {
                // Ëá™ÂàÜ„ÅÆ„É°„É≥„Éê„ÉºË°®Á§∫„ÅÆÂ†¥Âêà„ÅØlocalStorage„Åã„ÇâÂèñÂæó
                console.log('‚úì Using current user avatar from localStorage');
                avatarContent = `<img src="${currentUser.avatar_url}?t=${Date.now()}" alt="${currentUser.nickname || currentUser.username}" class="member-avatar-img">`;
            } else if (member.avatar_url) {
                // „É°„É≥„Éê„Éº„Éá„Éº„Çø„Å´„Ç¢„Éê„Çø„ÉºURLÊÉÖÂ†±„Åå„ÅÇ„ÇãÂ†¥Âêà
                console.log('‚úì Using member avatar_url:', member.avatar_url);
                avatarContent = `<img src="${member.avatar_url}?t=${Date.now()}" alt="${member.nickname || member.username}" class="member-avatar-img">`;
            } else {
                // „Éá„Éï„Ç©„É´„Éà„ÅØÊñáÂ≠ó„ÅÆ„Éó„É¨„Éº„Çπ„Éõ„É´„ÉÄ„Éº
                console.log('‚ö†Ô∏è No avatar found, using text placeholder');
                avatarContent = (member.nickname || member.username).charAt(0).toUpperCase();
            }
            
            return `
                <div class="member-item">
                    <div class="member-avatar">${avatarContent}</div>
                    <div class="member-info">
                        <span class="member-name">${member.nickname || member.username}</span>
                        <span class="member-activity">${type === 'online' ? (member.activity || 'LazyChillRoom„Çí‰ΩøÁî®‰∏≠') : (member.lastSeen || 'ÊúÄÁµÇ„É≠„Ç∞„Ç§„É≥: ‰∏çÊòé')}</span>
                    </div>
                    <div class="member-status ${type}"></div>
                </div>
            `;
        }).join('');
    }

    // ÁîªÂÉè„É¢„Éº„ÉÄ„É´„ÅÆHTML„ÇíÁîüÊàê
    static createImageModal() {
        return `
            <div class="image-modal" id="imageModal">
                <div class="image-modal-overlay"></div>
                <div class="image-modal-content">
                    <button class="image-modal-close" id="imageModalClose">&times;</button>
                    <img class="image-modal-image" id="imageModalImage" src="" alt="">
                    <div class="image-modal-info">
                        <div class="image-modal-filename" id="imageModalFilename"></div>
                        <div class="image-modal-size" id="imageModalSize"></div>
                    </div>
                </div>
            </div>
        `;
    }
}

// „Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„Éó„Å´ÁôªÈå≤
window.UIComponents = UIComponents;
